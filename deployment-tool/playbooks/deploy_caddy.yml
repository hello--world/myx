---
- name: Deploy Caddy (Official Installation)
  hosts: local
  become: yes
  vars:
    caddy_version: "latest"
  tasks:
    - name: Check if Caddy is already installed
      command: which caddy
      register: caddy_check
      changed_when: false
      failed_when: false

    - name: Check if Caddy systemd service exists
      command: systemctl list-unit-files | grep -q "^caddy.service" || echo "not_found"
      register: caddy_service_check
      changed_when: false
      failed_when: false

    - name: Install Caddy via official package (Debian/Ubuntu)
      block:
        - name: Install required packages for Debian
          apt:
            name:
              - debian-keyring
              - debian-archive-keyring
              - apt-transport-https
              - curl
            state: present

        - name: Add Caddy GPG key
          shell: |
            curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
            chmod o+r /usr/share/keyrings/caddy-stable-archive-keyring.gpg
          args:
            creates: /usr/share/keyrings/caddy-stable-archive-keyring.gpg

        - name: Add Caddy repository
          shell: |
            curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
            chmod o+r /etc/apt/sources.list.d/caddy-stable.list
          args:
            creates: /etc/apt/sources.list.d/caddy-stable.list

        - name: Update apt cache
          apt:
            update_cache: yes

        - name: Install Caddy
          apt:
            name: caddy
            state: present
      when: 
        - ansible_os_family == "Debian"
        - caddy_check.rc != 0 or caddy_service_check.stdout == "not_found"

    - name: Install Caddy via official package (Fedora/RedHat/CentOS)
      block:
        - name: Install dnf plugins
          package:
            name:
              - dnf-plugins-core
            state: present

        - name: Enable Caddy COPR repository
          shell: dnf copr enable -y @caddy/caddy
          args:
            creates: /etc/yum.repos.d/_copr:copr.fedorainfracloud.org:@caddy:caddy.repo

        - name: Install Caddy
          dnf:
            name: caddy
            state: present
      when:
        - ansible_os_family == "RedHat"
        - caddy_check.rc != 0 or caddy_service_check.stdout == "not_found"

    - name: Ensure Caddy directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /etc/caddy
        - /var/lib/caddy
      ignore_errors: yes

    - name: Check Caddy binary location
      command: which caddy
      register: caddy_bin_path
      changed_when: false
      failed_when: false

    - name: Set Caddy binary path
      set_fact:
        caddy_bin: "{{ caddy_bin_path.stdout | default('/usr/bin/caddy') }}"

    - name: Verify Caddy installation
      block:
        - name: Check Caddy binary exists
          stat:
            path: "{{ caddy_bin }}"
          register: caddy_binary_stat

        - name: Check Caddy systemd service exists
          command: systemctl list-unit-files | grep -q "^caddy.service" || echo "not_found"
          register: caddy_service_check
          changed_when: false
          failed_when: false

        - name: Check Caddy version
          command: "{{ caddy_bin }} version"
          register: caddy_version_result
          changed_when: false
          failed_when: false

        - name: Set installation success fact
          set_fact:
            caddy_installed: "{{ caddy_binary_stat.stat.exists | default(false) and caddy_service_check.rc == 0 and caddy_version_result.rc == 0 }}"

      always:
        - name: Fail if Caddy not properly installed
          fail:
            msg: "Caddy installation verification failed. Binary exists: {{ caddy_binary_stat.stat.exists | default(false) }}, Service exists: {{ caddy_service_check.rc == 0 }}, Version check: {{ caddy_version_result.rc == 0 }}"
          when: not caddy_installed | default(false)

    - name: Ensure Caddy service is started and enabled
      systemd:
        name: caddy
        state: started
        enabled: yes
      ignore_errors: yes

    - name: Display Caddy installation status
      debug:
        msg: "Caddy installation completed. Binary: {{ caddy_bin }}, Version: {{ caddy_version_result.stdout | default('unknown') }}"

