---
# Agent安装playbook
# 统一处理Agent的安装和升级（都使用全新安装方式）
#
# 执行方式：
# - SSH方式：服务器本地执行ansible-playbook，通过SSH连接到目标服务器
# - Agent方式：不适用（首次安装必须通过SSH）
#
# 前置条件：
# - Agent核心文件已通过SSH SFTP上传到 /opt/myx-agent/
# - 服务器已生成agent_token、rpc_port、rpc_path等配置
#
# Extra vars:
# - agent_token: Agent Token（服务器分配）
# - secret_key: 加密密钥（服务器分配）
# - http_port: HTTP端口（服务器随机分配）
# - http_path: HTTP路径（服务器随机分配，用于路径混淆）
# - certificate_path: SSL证书路径（可选，默认/etc/myx-agent/ssl/agent.crt）
# - private_key_path: SSL私钥路径（可选，默认/etc/myx-agent/ssl/agent.key）
# - certificate_content: SSL证书内容（可选，如果提供则写入证书文件）
# - private_key_content: SSL私钥内容（可选，如果提供则写入私钥文件）

- name: 安装MyX Agent
  hosts: all
  become: yes
  vars:
    agent_dir: /opt/myx-agent
    config_dir: /etc/myx-agent
    service_name: myx-agent

  tasks:
    # ============ 停止现有服务并清理旧文件 ============
    - name: 停止Agent服务（如果存在）
      systemd:
        name: "{{ service_name }}"
        state: stopped
      failed_when: false
      ignore_errors: yes

    - name: 等待服务完全停止
      wait_for:
        timeout: 3

    - name: 删除旧的Agent目录（强制覆盖）
      file:
        path: "{{ agent_dir }}"
        state: absent
      failed_when: false
      ignore_errors: yes

    - name: 重新创建Agent目录
      file:
        path: "{{ agent_dir }}"
        state: directory
        mode: '0755'

    # ============ 从临时目录复制Agent文件 ============
    - name: 从临时目录复制整个Agent目录
      copy:
        src: /tmp/myx-agent-files/
        dest: "{{ agent_dir }}/"
        remote_src: yes
        mode: preserve
      ignore_errors: yes

    - name: 设置main.py可执行权限
      file:
        path: "{{ agent_dir }}/main.py"
        mode: '0755'
      failed_when: false

    - name: 验证main.py是否存在
      stat:
        path: "{{ agent_dir }}/main.py"
      register: main_py_check

    - name: 如果main.py不存在则报错
      fail:
        msg: "Agent文件复制失败：main.py不存在，请检查临时目录 /tmp/myx-agent-files 是否存在文件"
      when: not main_py_check.stat.exists

    - name: 检查Python3是否安装
      command: python3 --version
      register: python_version
      failed_when: false
      changed_when: false

    - name: 验证Python版本
      fail:
        msg: "未检测到Python3，Agent需要Python 3.6+"
      when: python_version.rc != 0

    - name: 提取Python版本号
      set_fact:

        python_major: "{{ python_version.stdout | regex_search('\\d+') }}"
        python_minor: "{{ python_version.stdout | regex_search('\\d+\\.\\d+') | regex_replace('^\\d+\\.', '') }}"

    - name: 验证Python版本>=3.6
      fail:
        msg: "Python版本过低 ({{ python_version.stdout }})，需要3.6+"
      when: (python_major | int < 3) or (python_major | int == 3 and python_minor | int < 6)

    - name: 输出Python版本信息
      debug:
        msg: "检测到Python {{ python_version.stdout }}，继续安装..."

    - name: 验证Agent文件是否存在
      stat:
        path: "{{ agent_dir }}/main.py"
      register: agent_main_file

    - name: 失败如果Agent文件不存在
      fail:
        msg: "Agent文件不存在: {{ agent_dir }}/main.py"
      when: not agent_main_file.stat.exists

    # ============ 安装pip3（如果不存在） ============
    - name: 检查pip3是否已安装
      command: pip3 --version
      register: pip3_check
      failed_when: false
      changed_when: false

    - name: 安装python3-pip（Debian/Ubuntu）
      package:
        name: python3-pip
        state: present
      when: 
        - pip3_check.rc != 0
        - ansible_os_family == "Debian"
      ignore_errors: yes

    - name: 安装python3-pip（RedHat/CentOS）
      package:
        name: python3-pip
        state: present
      when: 
        - pip3_check.rc != 0
        - ansible_os_family == "RedHat"
      ignore_errors: yes

    # ============ 安装Ansible和依赖 ============
    - name: 检查Ansible是否已安装
      command: ansible-playbook --version
      register: ansible_check
      failed_when: false
      changed_when: false

    - name: 安装Ansible（如果未安装）
      package:
        name: ansible
        state: present
      when: ansible_check.rc != 0
      ignore_errors: yes

    - name: 安装Python依赖（使用requirements.txt，添加--break-system-packages和--ignore-installed参数）
      pip:
        requirements: "{{ agent_dir }}/requirements.txt"
        state: present
        executable: pip3
        extra_args: --break-system-packages --ignore-installed
      ignore_errors: yes

    - name: 输出依赖安装结果
      debug:
        msg: "依赖安装完成"

    # ============ 创建SSL证书目录 ============
    - name: 创建配置目录
      file:
        path: "{{ config_dir }}"
        state: directory
        mode: '0755'

    - name: 创建SSL证书目录
      file:
        path: "{{ config_dir }}/ssl"
        state: directory
        mode: '0755'

    # ============ 上传SSL证书 ============
    - name: 上传SSL证书
      copy:
        content: "{{ certificate_content }}"
        dest: "{{ certificate_path | default('/etc/myx-agent/ssl/agent.crt') }}"
        mode: '0644'
      when: certificate_content is defined and certificate_content != ""

    - name: 上传SSL私钥
      copy:
        content: "{{ private_key_content }}"
        dest: "{{ private_key_path | default('/etc/myx-agent/ssl/agent.key') }}"
        mode: '0600'
      when: private_key_content is defined and private_key_content != ""

    # ============ 创建systemd服务 ============
    - name: 创建systemd服务文件
      copy:
        content: |
          [Unit]
          Description=MyX Agent (Python)
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory={{ agent_dir }}
          ExecStart=/usr/bin/python3 {{ agent_dir }}/main.py
          Restart=always
          RestartSec=10
          Environment="PATH=/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin"
          Environment="AGENT_TOKEN={{ agent_token }}"
          Environment="SECRET_KEY={{ secret_key }}"
          Environment="HTTP_PORT={{ http_port }}"
          Environment="HTTP_PATH={{ http_path }}"
          Environment="CERTIFICATE_PATH={{ certificate_path | default('/etc/myx-agent/ssl/agent.crt') }}"
          Environment="PRIVATE_KEY_PATH={{ private_key_path | default('/etc/myx-agent/ssl/agent.key') }}"

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/{{ service_name }}.service
        mode: '0644'

    # ============ 启动服务 ============
    - name: 重新加载systemd
      systemd:
        daemon_reload: yes

    - name: 启用Agent服务
      systemd:
        name: "{{ service_name }}"
        enabled: yes

    - name: 启动Agent服务
      systemd:
        name: "{{ service_name }}"
        state: started

    # ============ 验证服务状态（带重试和日志检查） ============
    - name: 等待并检查服务状态（最多重试3次）
      block:
        - name: 等待服务启动
          wait_for:
            timeout: 15

        - name: 检查服务状态
          systemd:
            name: "{{ service_name }}"
          register: service_status
          failed_when: false

        - name: 读取服务日志（检查启动错误）
          command: journalctl -u {{ service_name }} -n 30 --no-pager
          register: service_log
          failed_when: false
          changed_when: false

        - name: 输出服务日志
          debug:
            msg: "{{ service_log.stdout_lines }}"
          when: service_log.stdout_lines is defined

        - name: 验证服务是否运行
          assert:
            that:
              - service_status.status.ActiveState == "active"
            fail_msg: |
              Agent服务启动失败，状态: {{ service_status.status.ActiveState }}
              请检查服务日志以获取详细错误信息
            success_msg: "Agent服务运行正常"
      rescue:
        - name: 重试检查服务状态（第2次）
          block:
            - name: 等待服务启动（重试）
              wait_for:
                timeout: 15

            - name: 检查服务状态（重试）
              systemd:
                name: "{{ service_name }}"
              register: service_status
              failed_when: false

            - name: 读取服务日志（重试时检查）
              command: journalctl -u {{ service_name }} -n 30 --no-pager
              register: service_log
              failed_when: false
              changed_when: false

            - name: 输出服务日志（重试）
              debug:
                msg: "{{ service_log.stdout_lines }}"
              when: service_log.stdout_lines is defined

            - name: 验证服务是否运行（重试）
              assert:
                that:
                  - service_status.status.ActiveState == "active"
                fail_msg: |
                  Agent服务启动失败，状态: {{ service_status.status.ActiveState }}
                  请检查服务日志以获取详细错误信息
                success_msg: "Agent服务运行正常"
          rescue:
            - name: 重试检查服务状态（第3次）
              block:
                - name: 等待服务启动（第3次重试）
                  wait_for:
                    timeout: 15

                - name: 检查服务状态（第3次重试）
                  systemd:
                    name: "{{ service_name }}"
                  register: service_status
                  failed_when: false

                - name: 读取服务日志（第3次重试时检查）
                  command: journalctl -u {{ service_name }} -n 30 --no-pager
                  register: service_log
                  failed_when: false
                  changed_when: false

                - name: 输出服务日志（第3次重试）
                  debug:
                    msg: "{{ service_log.stdout_lines }}"
                  when: service_log.stdout_lines is defined

                - name: 验证服务是否运行（第3次重试）
                  assert:
                    that:
                      - service_status.status.ActiveState == "active"
                    fail_msg: |
                      Agent服务启动失败，状态: {{ service_status.status.ActiveState }}
                      请检查服务日志以获取详细错误信息
                      如果依赖未安装成功，请检查pip3安装日志
                    success_msg: "Agent服务运行正常"


    # ============ 清理临时文件 ============
    - name: 清理临时目录
      file:
        path: /tmp/myx-agent-files
        state: absent
      failed_when: false
      ignore_errors: yes

    - name: 输出完成信息
      debug:
        msg: "[完成] Agent安装完成"
