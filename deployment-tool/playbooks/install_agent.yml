---
# Agent安装playbook
# 统一处理Agent的安装和升级（都使用全新安装方式）
#
# 执行方式：
# - SSH方式：服务器本地执行ansible-playbook，通过SSH连接到目标服务器
# - Agent方式：不适用（首次安装必须通过SSH）
#
# 前置条件：
# - Agent核心文件已通过SSH SFTP上传到 /opt/myx-agent/
# - 服务器已生成agent_token、rpc_port、rpc_path等配置
#
# Extra vars:
# - agent_token: Agent Token（服务器分配）
# - secret_key: 加密密钥（服务器分配）
# - rpc_port: RPC端口（服务器分配）
# - rpc_path: RPC路径（服务器分配，用于路径混淆）
# - certificate_path: SSL证书路径（可选，默认/etc/myx-agent/ssl/agent.crt）
# - private_key_path: SSL私钥路径（可选，默认/etc/myx-agent/ssl/agent.key）

- name: 安装MyX Agent
  hosts: all
  become: yes
  vars:
    agent_dir: /opt/myx-agent
    config_dir: /etc/myx-agent
    service_name: myx-agent

  tasks:
    # ============ 停止现有服务并清理旧文件 ============
    - name: 停止Agent服务（如果存在）
      systemd:
        name: "{{ service_name }}"
        state: stopped
      failed_when: false
      ignore_errors: yes

    - name: 等待服务完全停止
      wait_for:
        timeout: 3

    - name: 删除旧的Agent目录（强制覆盖）
      file:
        path: "{{ agent_dir }}"
        state: absent
      failed_when: false
      ignore_errors: yes

    - name: 重新创建Agent目录
      file:
        path: "{{ agent_dir }}"
        state: directory
        mode: '0755'
    - name: 检查Python3是否安装
      command: python3 --version
      register: python_version
      failed_when: false
      changed_when: false

    - name: 验证Python版本
      fail:
        msg: "未检测到Python3，Agent需要Python 3.6+"
      when: python_version.rc != 0

    - name: 提取Python版本号
      set_fact:

        python_major: "{{ python_version.stdout | regex_search('\\d+') }}"
        python_minor: "{{ python_version.stdout | regex_search('\\d+\\.\\d+') | regex_replace('^\\d+\\.', '') }}"

    - name: 验证Python版本>=3.6
      fail:
        msg: "Python版本过低 ({{ python_version.stdout }})，需要3.6+"
      when: (python_major | int < 3) or (python_major | int == 3 and python_minor | int < 6)

    - name: 输出Python版本信息
      debug:
        msg: "检测到Python {{ python_version.stdout }}，继续安装..."

    - name: 验证Agent文件是否存在
      stat:
        path: "{{ agent_dir }}/main.py"
      register: agent_main_file

    - name: 失败如果Agent文件不存在
      fail:
        msg: "Agent文件不存在: {{ agent_dir }}/main.py"
      when: not agent_main_file.stat.exists

    # ============ 安装uv工具 ============
    - name: 检查uv是否已安装
      command: /usr/local/bin/uv --version
      register: uv_check
      failed_when: false
      changed_when: false

    - name: 安装uv到/usr/local/bin
      shell: |
        curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR=/usr/local/bin INSTALLER_NO_MODIFY_PATH=1 sh
      when: uv_check.rc != 0

    - name: 验证uv是否可用
      command: /usr/local/bin/uv --version
      register: uv_verify
      failed_when: uv_verify.rc != 0

    # ============ 安装Python依赖 ============
    - name: 检查pyproject.toml是否存在
      stat:
        path: "{{ agent_dir }}/pyproject.toml"
      register: pyproject_file

    - name: 使用uv sync安装依赖（如果有pyproject.toml）
      shell: |
        cd {{ agent_dir }}
        /usr/local/bin/uv sync
      when: pyproject_file.stat.exists
      register: uv_sync_result
      failed_when: uv_sync_result.rc != 0

    - name: 使用uv pip install安装依赖（如果没有pyproject.toml）
      shell: |
        cd {{ agent_dir }}
        /usr/local/bin/uv pip install -r requirements.txt
      when: not pyproject_file.stat.exists
      register: uv_install_deps
      failed_when: uv_install_deps.rc != 0

    - name: 输出依赖安装结果
      debug:
        msg: "Python依赖安装完成（使用{{ 'pyproject.toml' if pyproject_file.stat.exists else 'requirements.txt' }}）"

    # ============ 创建配置文件 ============
    - name: 创建配置目录
      file:
        path: "{{ config_dir }}"
        state: directory
        mode: '0755'

    - name: 创建SSL证书目录
      file:
        path: "{{ config_dir }}/ssl"
        state: directory
        mode: '0755'

    - name: 创建Agent配置文件
      copy:
        content: |
          {
              "agent_token": "{{ agent_token }}",
              "secret_key": "{{ secret_key }}",
              "rpc_port": {{ rpc_port }},
              "rpc_path": "{{ rpc_path }}",
              "certificate_path": "{{ certificate_path | default('/etc/myx-agent/ssl/agent.crt') }}",
              "private_key_path": "{{ private_key_path | default('/etc/myx-agent/ssl/agent.key') }}"
          }
        dest: "{{ config_dir }}/config.json"
        mode: '0600'

    - name: 输出配置创建结果
      debug:
        msg: "Agent配置文件已创建（Token、RPC端口和路径已由服务器分配）"

    # ============ 创建systemd服务 ============
    - name: 创建systemd服务文件
      copy:
        content: |
          [Unit]
          Description=MyX Agent (Python)
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory={{ agent_dir }}
          ExecStart=/usr/local/bin/uv run {{ agent_dir }}/main.py
          Restart=always
          RestartSec=10
          Environment="PATH=/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin"

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/{{ service_name }}.service
        mode: '0644'

    # ============ 启动服务 ============
    - name: 重新加载systemd
      systemd:
        daemon_reload: yes

    - name: 启用Agent服务
      systemd:
        name: "{{ service_name }}"
        enabled: yes

    - name: 启动Agent服务
      systemd:
        name: "{{ service_name }}"
        state: started

    - name: 等待服务启动
      wait_for:
        timeout: 3

    - name: 输出完成信息
      debug:
        msg: "[完成] Agent安装完成"
