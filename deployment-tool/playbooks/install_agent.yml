---
# Agent安装playbook
# 替代原有的Bash heredoc脚本，统一使用Ansible管理
#
# 执行方式：
# - SSH方式：服务器本地执行ansible-playbook，通过SSH连接到目标服务器
# - Agent方式：不适用（首次安装必须通过SSH）
#
# 前置条件：
# - Agent核心文件已通过SSH SFTP上传到 /opt/myx-agent/
# - 服务器已生成agent_token、rpc_port、rpc_path等配置
#
# Extra vars:
# - agent_token: Agent Token（服务器分配）
# - secret_key: 加密密钥（服务器分配）
# - rpc_port: RPC端口（服务器分配）
# - rpc_path: RPC路径（服务器分配，用于路径混淆）
# - certificate_path: SSL证书路径（可选，默认/etc/myx-agent/ssl/agent.crt）
# - private_key_path: SSL私钥路径（可选，默认/etc/myx-agent/ssl/agent.key）

- name: 安装MyX Agent
  hosts: all
  become: yes
  vars:
    agent_dir: /opt/myx-agent
    config_dir: /etc/myx-agent
    service_name: myx-agent

  tasks:
    - name: 检查Python3是否安装
      command: python3 --version
      register: python_version
      failed_when: false
      changed_when: false

    - name: 验证Python版本
      fail:
        msg: "未检测到Python3，Agent需要Python 3.6+"
      when: python_version.rc != 0

    - name: 提取Python版本号
      set_fact:
        python_major: "{{ python_version.stdout | regex_search('\\d+') }}"
        python_minor: "{{ python_version.stdout | regex_search('\\d+\\.\\d+') | regex_replace('^\\d+\\.', '') }}"

    - name: 验证Python版本>=3.6
      fail:
        msg: "Python版本过低 ({{ python_version.stdout }})，需要3.6+"
      when: (python_major | int < 3) or (python_major | int == 3 and python_minor | int < 6)

    - name: 输出Python版本信息
      debug:
        msg: "检测到Python {{ python_version.stdout }}，继续安装..."

    - name: 验证Agent文件是否存在
      stat:
        path: "{{ agent_dir }}/main.py"
      register: agent_main_file

    - name: 失败如果Agent文件不存在
      fail:
        msg: "Agent文件不存在: {{ agent_dir }}/main.py"
      when: not agent_main_file.stat.exists

    # ============ 安装uv工具 ============
    - name: 检查uv是否已安装
      command: uv --version
      register: uv_check
      failed_when: false
      changed_when: false

    - name: 安装uv（使用官方安装脚本）
      shell: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
      when: uv_check.rc != 0
      register: uv_install_result
      failed_when: false

    - name: 尝试使用pip安装uv（如果官方脚本失败）
      shell: |
        if command -v pip3 &> /dev/null; then
          pip3 install --user uv || pip3 install --user --break-system-packages uv
        fi
      when: uv_check.rc != 0 and uv_install_result.rc != 0
      failed_when: false

    - name: 查找uv路径
      shell: |
        if command -v uv &> /dev/null; then
          command -v uv | head -n 1
        elif [ -f "$HOME/.cargo/bin/uv" ]; then
          echo "$HOME/.cargo/bin/uv"
        elif [ -f "$HOME/.local/bin/uv" ]; then
          echo "$HOME/.local/bin/uv"
        else
          echo "not_found"
        fi
      register: uv_path_result
      changed_when: false

    - name: 设置uv路径变量（清理换行符）
      set_fact:
        uv_path: "{{ uv_path_result.stdout | trim }}"

    - name: 验证uv是否可用
      fail:
        msg: "uv安装失败或不在PATH中"
      when: uv_path == "not_found"

    - name: 创建uv符号链接到/usr/local/bin
      file:
        src: "{{ uv_path }}"
        dest: /usr/local/bin/uv
        state: link
        force: yes
      when: uv_path != "/usr/local/bin/uv" and uv_path != "not_found"
      failed_when: false
      register: uv_symlink_result

    - name: 更新uv路径为符号链接路径（如果符号链接创建成功）
      set_fact:
        uv_path: "/usr/local/bin/uv"
      when: uv_path != "/usr/local/bin/uv" and uv_path != "not_found" and uv_symlink_result is succeeded

    - name: 输出uv路径信息
      debug:
        msg: "使用uv路径: {{ uv_path }}"

    # ============ 安装Python依赖 ============
    - name: 检查pyproject.toml是否存在
      stat:
        path: "{{ agent_dir }}/pyproject.toml"
      register: pyproject_file

    - name: 使用uv sync创建虚拟环境（如果有pyproject.toml）
      shell: |
        cd {{ agent_dir }}
        "{{ uv_path }}" sync
      when: pyproject_file.stat.exists
      failed_when: false
      register: uv_sync_result

    - name: 使用uv pip install安装依赖
      shell: |
        cd {{ agent_dir }}
        "{{ uv_path }}" pip install -r requirements.txt
      register: uv_install_deps
      failed_when: uv_install_deps.rc != 0

    - name: 输出依赖安装结果
      debug:
        msg: "Python依赖安装完成（使用uv）"

    - name: 验证关键依赖是否已安装
      shell: |
        cd {{ agent_dir }}
        {{ uv_path }} pip list | grep -E "Flask|ansible-runner" || (echo "错误: 关键依赖未安装" && exit 1)
      register: verify_deps_result

    # ============ 创建配置文件 ============
    - name: 创建配置目录
      file:
        path: "{{ config_dir }}"
        state: directory
        mode: '0755'

    - name: 创建SSL证书目录
      file:
        path: "{{ config_dir }}/ssl"
        state: directory
        mode: '0755'

    - name: 创建Agent配置文件
      copy:
        content: |
          {
              "agent_token": "{{ agent_token }}",
              "secret_key": "{{ secret_key }}",
              "rpc_port": {{ rpc_port }},
              "rpc_path": "{{ rpc_path }}",
              "certificate_path": "{{ certificate_path | default('/etc/myx-agent/ssl/agent.crt') }}",
              "private_key_path": "{{ private_key_path | default('/etc/myx-agent/ssl/agent.key') }}"
          }
        dest: "{{ config_dir }}/config.json"
        mode: '0600'

    - name: 输出配置创建结果
      debug:
        msg: "Agent配置文件已创建（Token、RPC端口和路径已由服务器分配）"

    # ============ 创建systemd服务 ============
    - name: 创建systemd服务文件
      copy:
        content: |
          [Unit]
          Description=MyX Agent (Python)
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory={{ agent_dir }}
          # 优先使用虚拟环境中的Python，否则使用uv run
          ExecStart=/bin/bash -c 'UV_PATH=$(command -v uv 2>/dev/null || echo "$HOME/.cargo/bin/uv"); if [ ! -f "$UV_PATH" ] && [ -f "$HOME/.local/bin/uv" ]; then UV_PATH="$HOME/.local/bin/uv"; fi; if [ -d .venv ] && [ -f .venv/bin/python3 ]; then .venv/bin/python3 {{ agent_dir }}/main.py; else "$UV_PATH" run {{ agent_dir }}/main.py; fi'
          Restart=always
          RestartSec=10
          Environment="PATH=/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin:/root/.cargo/bin:/root/.local/bin"

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/{{ service_name }}.service
        mode: '0644'

    # ============ 启动服务 ============
    - name: 重新加载systemd
      systemd:
        daemon_reload: yes

    - name: 启用Agent服务
      systemd:
        name: "{{ service_name }}"
        enabled: yes

    - name: 启动Agent服务
      systemd:
        name: "{{ service_name }}"
        state: started

    - name: 等待服务启动
      wait_for:
        timeout: 3

    - name: 输出完成信息
      debug:
        msg: "[完成] Agent安装完成"
