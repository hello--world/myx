# Agent API 说明

## 1. 心跳 API (`/api/agents/heartbeat/`)

### 用途
- **保持连接状态**：Agent 定期（随机 30-300 秒）向服务器发送心跳，告知服务器 Agent 仍然在线
- **更新状态**：更新 Agent 的在线状态和最后心跳时间
- **健康检查**：服务器可以通过心跳判断 Agent 是否正常运行
- **随机化**：使用随机间隔可以避免多个 Agent 同时请求，减少服务器负载

### 工作流程
1. Agent 在 30-300 秒之间随机选择一个间隔发送心跳请求
2. 服务器更新 Agent 的 `last_heartbeat` 和 `status = 'online'`
3. 如果长时间没有心跳，服务器可以判断 Agent 离线

### 请求示例
```http
POST /api/agents/heartbeat/
X-Agent-Token: <Agent Token>
Content-Type: application/json

{
  "status": "online",
  "version": "1.0.0"
}
```

## 2. 轮询命令 API (`/api/agents/poll/`)

### 用途
- **获取待执行命令**：Agent 定期（随机 5-60 秒）轮询服务器，获取需要执行的命令
- **更新心跳**：轮询时也会更新心跳时间（双重保障）
- **命令队列**：服务器将需要执行的命令放入队列，Agent 通过轮询获取
- **随机化**：使用随机间隔可以避免多个 Agent 同时请求，减少服务器负载

### 工作流程
1. Agent 在 5-60 秒之间随机选择一个间隔轮询服务器
2. 服务器检查是否有该 Agent 的待执行命令
3. 如果有命令，返回命令列表
4. Agent 执行命令并返回结果

### 请求示例
```http
GET /api/agents/poll/
X-Agent-Token: <Agent Token>
```

### 响应示例
```json
{
  "commands": [
    {
      "id": 1,
      "command": "install_xray",
      "args": [],
      "timeout": 300
    }
  ],
  "status": "ok"
}
```

## 为什么需要两个 API？

### 心跳 API（随机 30-300 秒间隔）
- **目的**：状态监控
- **频率**：较低（随机 30-300 秒）
- **数据量**：小（只发送状态信息）
- **随机化**：避免多个 Agent 同时请求，减少服务器负载峰值

### 轮询命令 API（随机 5-60 秒间隔）
- **目的**：命令获取
- **频率**：较高（随机 5-60 秒），确保命令及时执行
- **数据量**：可能较大（包含命令详情）
- **随机化**：避免多个 Agent 同时请求，减少服务器负载峰值

### 双重心跳机制
- 轮询时也会更新心跳时间
- 即使心跳 API 失败，轮询 API 也能保持连接状态
- 提高可靠性

### 随机间隔的优势
- **负载均衡**：多个 Agent 不会同时请求，减少服务器压力
- **安全性**：随机化可以降低被检测的风险
- **灵活性**：在保证及时响应的同时，减少不必要的请求

## 实际应用场景

1. **部署 Xray**：通过命令队列发送安装命令
2. **部署 Caddy**：通过命令队列发送配置命令
3. **更新配置**：通过命令队列发送配置文件更新命令
4. **状态监控**：通过心跳判断服务器是否在线

## 性能考虑

- 心跳间隔（随机 30-300 秒）：减少服务器负载，随机化避免峰值
- 轮询间隔（随机 5-60 秒）：平衡响应速度和服务器负载，随机化避免峰值
- 如果命令队列为空，返回空数组，不会影响性能
- 随机间隔确保多个 Agent 的请求分散在不同时间，避免同时请求造成的服务器压力
