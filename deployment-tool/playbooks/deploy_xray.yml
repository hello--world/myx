---
- name: Deploy Xray (Host)
  hosts: local
  become: yes
  vars:
    xray_version: "latest"
  tasks:
    - name: Install required packages
      package:
        name:
          - curl
        state: present

    - name: Download Xray installation script (Official)
      get_url:
        url: https://github.com/XTLS/Xray-install/raw/main/install-release.sh
        dest: /tmp/install-xray.sh
        mode: '0755'

    - name: Execute Xray installation script (Official)
      shell: bash /tmp/install-xray.sh
      register: install_result
      changed_when: true
      failed_when: false  # 允许非零退出码，后续通过验证判断是否成功

    - name: Display installation output
      debug:
        msg: "{{ install_result.stdout_lines }}"
      when: install_result.stdout_lines is defined

    - name: Create Xray systemd service file
      copy:
        dest: /etc/systemd/system/xray.service
        content: |
          [Unit]
          Description=Xray Service
          Documentation=https://github.com/xtls/xray-core
          After=network.target nss-lookup.target

          [Service]
          Type=simple
          User=root
          CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
          AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
          NoNewPrivileges=true
          ExecStart=/usr/local/bin/xray run -config /usr/local/etc/xray/config.json
          Restart=on-failure
          RestartPreventExitStatus=23
          LimitNOFILE=1000000

          [Install]
          WantedBy=multi-user.target
        mode: '0644'

    - name: Ensure Xray config directory exists
      file:
        path: /usr/local/etc/xray
        state: directory
        mode: '0755'

    - name: Check if Xray config exists
      stat:
        path: /usr/local/etc/xray/config.json
      register: xray_config

    - name: Backup existing config if it exists and has errors
      shell: |
        if [ -f /usr/local/etc/xray/config.json ]; then
          # 尝试验证配置文件
          if ! /usr/local/bin/xray run -config /usr/local/etc/xray/config.json -test 2>&1 | grep -q "Configuration OK"; then
            echo "配置文件有错误，备份旧配置"
            mv /usr/local/etc/xray/config.json /usr/local/etc/xray/config.json.backup.$(date +%Y%m%d_%H%M%S)
            echo "BACKUP_CREATED"
          else
            echo "配置文件正常"
          fi
        else
          echo "配置文件不存在"
        fi
      register: backup_result
      changed_when: "'BACKUP_CREATED' in backup_result.stdout"
      failed_when: false

    - name: Create default Xray config if not exists or backup was created
      copy:
        dest: /usr/local/etc/xray/config.json
        content: |
          {
            "log": {
              "loglevel": "warning"
            },
            "inbounds": [],
            "outbounds": [
              {
                "protocol": "freedom",
                "tag": "direct"
              }
            ]
          }
        mode: '0644'
      when: not xray_config.stat.exists or 'BACKUP_CREATED' in backup_result.stdout

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Verify Xray installation after script execution
      block:
        - name: Check Xray binary exists
          stat:
            path: /usr/local/bin/xray
          register: xray_binary

        - name: Check Xray systemd service exists
          command: systemctl list-unit-files | grep -q "^xray.service" || echo "not_found"
          register: xray_service
          changed_when: false
          failed_when: false

        - name: Check Xray version
          command: /usr/local/bin/xray version
          register: xray_version_check
          changed_when: false
          failed_when: false

        - name: Set installation success fact
          set_fact:
            xray_installed: "{{ xray_binary.stat.exists | default(false) and xray_service.rc == 0 and xray_version_check.rc == 0 }}"

      always:
        - name: Fail if Xray not properly installed
          fail:
            msg: "Xray installation verification failed. Binary exists: {{ xray_binary.stat.exists | default(false) }}, Service exists: {{ xray_service.rc == 0 }}, Version check: {{ xray_version_check.rc == 0 }}"
          when: not xray_installed | default(false)

    - name: Enable Xray service (but don't start yet, will be started when config is ready)
      systemd:
        name: xray
        enabled: yes
        daemon_reload: yes
      ignore_errors: yes

    - name: Display Xray version
      debug:
        msg: "Xray installed successfully: {{ xray_version_check.stdout | default('Version check failed') }}. Service enabled but not started yet - will start after configuration."

