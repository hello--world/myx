---
# 服务检测playbook
# 用于检测服务（如xray、caddy）是否已安装
# 优先检查二进制文件，其次检查systemd服务，最后检查Docker容器
#
# Extra vars:
# - service_name: 服务名称（如 'xray' 或 'caddy'）
# - deployment_target: 部署目标（'host' 或 'docker'，默认为 'host'）

- name: 检测服务是否已安装
  hosts: localhost
  become: no
  vars:
    service_name: "{{ service_name | default('xray') }}"
    deployment_target: "{{ deployment_target | default('host') }}"
    installed: false
    detection_method: ""

  tasks:
    # 优先级1: 检查二进制文件是否存在（最可靠）
    - name: 检查Xray二进制文件（如果服务是xray）
      block:
        - name: 检查 /usr/local/bin/xray
          stat:
            path: /usr/local/bin/xray
          register: xray_bin_1
          failed_when: false

        - name: 检查 /usr/bin/xray
          stat:
            path: /usr/bin/xray
          register: xray_bin_2
          failed_when: false

        - name: 设置Xray安装状态
          set_fact:
            installed: "{{ xray_bin_1.stat.exists | default(false) or xray_bin_2.stat.exists | default(false) }}"
            detection_method: "Xray二进制文件存在: {{ xray_bin_1.stat.exists | ternary('/usr/local/bin/xray', '/usr/bin/xray') }}"
          when: xray_bin_1.stat.exists | default(false) or xray_bin_2.stat.exists | default(false)
      when: service_name == "xray"

    - name: 检查Caddy二进制文件（如果服务是caddy）
      block:
        - name: 检查 /usr/bin/caddy
          stat:
            path: /usr/bin/caddy
          register: caddy_bin_1
          failed_when: false

        - name: 检查 /usr/local/bin/caddy
          stat:
            path: /usr/local/bin/caddy
          register: caddy_bin_2
          failed_when: false

        - name: 检查 /opt/caddy/caddy
          stat:
            path: /opt/caddy/caddy
          register: caddy_bin_3
          failed_when: false

        - name: 设置Caddy安装状态
          set_fact:
            installed: "{{ caddy_bin_1.stat.exists | default(false) or caddy_bin_2.stat.exists | default(false) or caddy_bin_3.stat.exists | default(false) }}"
            detection_method: "Caddy二进制文件存在: {{ caddy_bin_1.stat.exists | ternary('/usr/bin/caddy', (caddy_bin_2.stat.exists | ternary('/usr/local/bin/caddy', '/opt/caddy/caddy'))) }}"
          when: caddy_bin_1.stat.exists | default(false) or caddy_bin_2.stat.exists | default(false) or caddy_bin_3.stat.exists | default(false)
      when: service_name == "caddy"

    - name: 检查其他服务的二进制文件（通过which命令）
      block:
        - name: 查找命令路径
          command: which {{ service_name }}
          register: which_result
          changed_when: false
          failed_when: false

        - name: 设置其他服务安装状态
          set_fact:
            installed: "{{ which_result.rc == 0 }}"
            detection_method: "命令在PATH中: {{ which_result.stdout }}"
          when: which_result.rc == 0
      when: service_name != "xray" and service_name != "caddy" and not installed

    # 优先级2: 如果二进制文件不存在，检查systemd服务
    - name: 检查systemd服务文件
      block:
        - name: 检查systemd服务文件是否存在
          command: systemctl list-unit-files {{ service_name }}.service
          register: systemd_check
          changed_when: false
          failed_when: false

        - name: 设置systemd服务安装状态
          set_fact:
            installed: true
            detection_method: "systemd服务文件存在"
          when: systemd_check.rc == 0 and not installed
      when: not installed

    # 优先级3: 检查服务状态（作为最后的确认）
    - name: 检查服务状态
      block:
        - name: 检查服务状态
          command: systemctl status {{ service_name }}
          register: status_check
          changed_when: false
          failed_when: false

        - name: 设置服务状态安装信息
          set_fact:
            installed: true
            detection_method: "systemd服务存在（状态: {{ '运行中' if status_check.rc == 0 else ('失败' if status_check.rc == 1 else '已停止') }}）"
          when: status_check.rc in [0, 1, 3] and not installed
      when: not installed

    # 优先级4: 如果部署目标是docker，检查Docker容器
    - name: 检查Docker容器（如果部署目标是docker）
      block:
        - name: 检查Docker容器是否存在
          command: docker ps -a --filter name={{ service_name }} --format "{{ '{{' }}.Names{{ '}}' }}"
          register: docker_check
          changed_when: false
          failed_when: false

        - name: 设置Docker容器安装状态
          set_fact:
            installed: true
            detection_method: "Docker容器存在: {{ service_name }}"
          when: docker_check.rc == 0 and docker_check.stdout.strip() == service_name and not installed
      when: deployment_target == "docker" and not installed

    # 输出结果（格式与check_service.py脚本一致，使用echo输出到stdout）
    - name: 输出检测结果（已安装）
      command: echo "INSTALLED"
      register: output_installed
      when: installed
      changed_when: false

    - name: 输出检测方式（已安装）
      command: echo "检测方式: {{ detection_method }}"
      register: output_method
      when: installed
      changed_when: false

    - name: 输出检测结果（未安装）
      command: echo "NOT_INSTALLED"
      register: output_not_installed
      when: not installed
      changed_when: false

